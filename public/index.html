<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>aulibe</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <header class="site-header">
    <div class="header-inner">

      <div class="title-box">
        <h1 class="site-title">aulibe</h1>
        <p class="tagline">FOR MF</p>
      </div>

      <!-- ✔ ヘッダー右上カートボタン -->
      <div class="cart-button">
        <a href="checkout.html">カート (<span id="cart-count">0</span>)</a>
      </div>

    </div>

    <nav class="sub-nav">
      <ul class="sub-nav-menu">
        <li><a href="tokusho.html" target="_blank">特定商取引法に基づく表記</a></li>
        <li><a href="corporate.html" target="_blank">運営者情報</a></li>
        <li><a href="access.html" target="_blank">お問い合わせ</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="products" id="product-list">
      <!-- 商品カードは JS で生成 -->
    </section>

    <!-- 画像拡大モーダル -->
    <div id="img-modal" class="img-modal">
      <span class="img-close">&times;</span>
      <img class="img-modal-content" id="modal-img">
    </div>
  </main>

  <script>
    // 商品一覧を読み込む
    async function loadProducts() {
      const res = await fetch("/products");
      const products = await res.json();

      const list = document.getElementById("product-list");
      list.innerHTML = "";

      products.forEach(p => {
        list.innerHTML += `
          <div class="product-card">
            <img src="img/${p.id}.jpg" class="product-img">
            <h3>${p.name}</h3>
            <p>¥${p.price.toLocaleString()}</p>
            <button class="add-cart-btn"
              data-id="${p.id}"
              data-name="${p.name}"
              data-price="${p.price}">
              カートに入れる
            </button>
          </div>
        `;
      });

      // ⚡重要：商品が描画された後でイベントを設定！
      attachBuyEvents();
    }

    // カートの個数を更新
    function loadCartCount() {
          const cart = JSON.parse(localStorage.getItem("cart") || "[]");
          const count = cart.reduce((sum, item) => sum + item.qty, 0);
          const el = document.getElementById("cart-count");
          if (el) el.textContent = count;
        }
    loadCartCount();
    

    // 商品一覧を読み込む
    function attachBuyEvents() {

    // カートに追加
  document.querySelectorAll(".add-cart-btn").forEach(btn => {
    btn.onclick = () => {
      addToCart({
        id: Number(btn.dataset.id),
        name: btn.dataset.name,
        price: Number(btn.dataset.price)
      });
    };
  });

  // 画像クリックで拡大
  document.querySelectorAll(".product-img").forEach(img => {
    img.onclick = () => {
      modalImg.src = img.src;
      imgModal.style.display = "block";
    };
  });

} // ← この1個だけでOK

    // 画像クリックで拡大
    document.querySelectorAll(".product-img").forEach(img => {
      img.onclick = () => {
        modalImg.src = img.src;
        imgModal.style.display = "block";
      };
    });
  


    // カート機能
    function addToCart(product) {
      let cart = JSON.parse(localStorage.getItem("cart") || "[]");

      const exist = cart.find(item => item.id === product.id);
      if (exist) {
        alert("この商品はお一人様1点までです");
        return;
      }

      // 新規追加（qty は常に 1）
      cart.push({ ...product, qty: 1 });

      localStorage.setItem("cart", JSON.stringify(cart));
      loadCartCount(); // ← 関数名も修正（後述）
      alert("カートに追加しました！");
    }

    loadProducts();
  </script>

  <footer class="site-footer">
    <p class="site-name">aulibe</p>
    <p class="accepted-text">お支払い方法：</p>
    <p class="payment-text">Visa / Mastercard / JCB / PayPay</p>
    <p class="small-note">※ロゴは商標ガイドラインに基づき省略しています。</p>
    
    <p class="tokusho-link"><a href="tokusho.html" target="_blank">特定商取引法に基づく表記</a></p>
  </footer>
</body>
</html>