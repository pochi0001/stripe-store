<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Mode Apparel</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://js.stripe.com/v3/"></script>
</head>

<body>
  <header class="site-header">
    <div class="header-inner">

      <div class="title-box">
        <h1 class="site-title">aulibe</h1>
        <p class="tagline">FOR MF</p>
      </div>

      <!-- ✔ ヘッダー右上カートボタン -->
      <div class="cart-button">
        <a href="checkout.html">カート (<span id="cart-count">0</span>)</a>
      </div>

    </div>

    <nav class="sub-nav">
      <ul class="sub-nav-menu">
        <li><a href="tokusho.html" target="_blank">Legal Info</a></li>
        <li><a href="corporate.html" target="_blank">Corporate</a></li>
        <li><a href="access.html" target="_blank">Contact</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="products" id="product-list">
      <!-- 商品カードは JS で生成 -->
    </section>

    <!-- 購入者情報フォーム -->
    <div id="customer-info">
      <h3>お届け先情報</h3>
      <label>名前：
        <input type="text" id="customer-name" required>
      </label><br>
      <label>住所：
        <input type="text" id="customer-address" required>
      </label><br>
      <label>メールアドレス（必須）：
        <input type="email" id="customer-email" required>
      </label><br>
      <label>電話番号：
        <input type="text" id="customer-phone">
      </label><br>
    </div>

    <!-- 画像拡大モーダル -->
    <div id="img-modal" class="img-modal">
      <span class="img-close">&times;</span>
      <img class="img-modal-content" id="modal-img">
    </div>
  </main>

  <!-- Stripe モーダル -->
  <div id="stripe-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>カード情報を入力</h2>
      <div id="card-element"></div>
      <button id="confirm-payment">支払う</button>
      <p id="stripe-message"></p>
    </div>
  </div>

  <script>
    let selectedProduct = {};

    // 電話番号フォーマットチェック（10桁または11桁、ハイフンOK）
    function validatePhone(phone) {
      const numbers = phone.replace(/-/g, ""); // ハイフン削除
      return /^\d+$/.test(numbers) && (numbers.length === 10 || numbers.length === 11);
    }

    // 入力未記入チェック
    function validateCustomerInfo() {
      const name = document.getElementById("customer-name").value.trim();
      const address = document.getElementById("customer-address").value.trim();
      const phone = document.getElementById("customer-phone").value.trim();
      const email = document.getElementById("customer-email").value.trim();

      if (!name || !address || !phone || !email) {
        alert("名前・住所・電話番号・メールアドレスをすべて入力してください");
        return false;
      }

      if (!validatePhone(phone)) {
        alert("電話番号が正しくありません（10〜11桁の数字、ハイフン可）");
        return false;
      }
      // email の形式チェック
      if (!email.match(/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/)) {
        alert("メールアドレスの形式が不正です");
        return false;
      }

      return { name, address, phone, email }; // ← email を返す
    }

    // 商品一覧を読み込む
    async function loadProducts() {
      const res = await fetch("/products");
      const products = await res.json();

      const list = document.getElementById("product-list");
      list.innerHTML = "";

      products.forEach(p => {
        list.innerHTML += `
          <div class="product-card">
            <img src="img/${p.id}.jpg" class="product-img">
            <h3>${p.name}</h3>
            <p>¥${p.price.toLocaleString()}</p>
            <button class="add-cart-btn"
              data-id="${p.id}"
              data-name="${p.name}"
              data-price="${p.price}">
              カートに入れる
            </button>
          </div>
        `;
      });

      // ⚡重要：商品が描画された後でイベントを設定！
      attachBuyEvents();
    }

    // カートの個数を更新
    function loadCartCount() {
          const cart = JSON.parse(localStorage.getItem("cart") || "[]");
          const count = cart.reduce((sum, item) => sum + item.qty, 0);
          const el = document.getElementById("cart-count");
          if (el) el.textContent = count;
        }
    loadCartCount();
    

    // 商品一覧を読み込む
    function attachBuyEvents() {

    // カートに追加
    document.querySelectorAll(".add-cart-btn").forEach(btn => {
      btn.onclick = () => {
        addToCart({
          id: Number(btn.dataset.id),
          name: btn.dataset.name,
          price: Number(btn.dataset.price)
        });
      };
    });

    // Stripeボタン
    document.querySelectorAll(".stripe-btn").forEach(btn => {
      btn.onclick = () => {
        const customer = validateCustomerInfo();
        if (!customer) return;

        selectedProduct = {
          name: btn.dataset.name,
          price: parseInt(btn.dataset.price),
          customer
        };
        modal.style.display = "block";
      };
    });

    // PayPayボタン
    document.querySelectorAll(".paypay-btn").forEach(btn => {
      btn.onclick = async () => {
        const customer = validateCustomerInfo();
        if (!customer) return;

        const amount = parseInt(btn.dataset.price) * 100;

        const res = await fetch("/paypay-payment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amount: amount,
            description: btn.dataset.name,
            name: customer.name,
            address: customer.address,
            phone: customer.phone,
            email: customer.email
          }),
        });

        const data = await res.json();
        if (data.status === "success") {
          alert(`PayPay決済完了！金額: ¥${parseInt(btn.dataset.price)}`);
          window.location.href = "/success.html";
        } else {
          alert("PayPay決済失敗：" + (data.message || ""));
        }
      };
    });

    // 画像クリックで拡大
    document.querySelectorAll(".product-img").forEach(img => {
      img.onclick = () => {
        modalImg.src = img.src;
        imgModal.style.display = "block";
      };
    });
  }


    // カート機能
    function addToCart(product) {
      let cart = JSON.parse(localStorage.getItem("cart") || "[]");

      const exist = cart.find(item => item.id === product.id);
      if (exist) {
        exist.qty += 1;
      } else {
        cart.push({ ...product, qty: 1 });
      }

      localStorage.setItem("cart", JSON.stringify(cart));
      updateCartCount(); // ← 追加
      alert("カートに追加しました！");
    }
    

    // ---------------- Stripe設定 ----------------
    const stripe = Stripe("pk_test_51SQTLLRytEfLIwOYuSDMMX63MpF0xZYUGwzpFC13lHufZlVubPhhmQr3QbWMVsLoR8iOgn2m0ftK129AYnRP48o200RqBen43R"); // 自分の公開キー
    const elements = stripe.elements();
    const cardElement = elements.create("card");
    cardElement.mount("#card-element");

    const modal = document.getElementById("stripe-modal");
    const closeModal = document.querySelector(".close");
    const stripeMessage = document.getElementById("stripe-message");
    const imgModal = document.getElementById("img-modal");
    const modalImg = document.getElementById("modal-img");
    const imgClose = document.querySelector(".img-close");

    closeModal.onclick = () => (modal.style.display = "none");
    imgClose.onclick = () => (imgModal.style.display = "none");

    window.onclick = (e) => {
      if (e.target == modal) modal.style.display = "none";
      if (e.target == imgModal) imgModal.style.display = "none";
    };

    document.getElementById("confirm-payment").onclick = async () => {
  const customer = validateCustomerInfo();
  if (!customer) return; // 入力不正なら処理停止

  stripeMessage.textContent = "決済中…";
  const res = await fetch("/create-payment-intent", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      amount: selectedProduct.price * 100,
      description: selectedProduct.name,
      name: customer.name,
      address: customer.address,
      phone: customer.phone,
      email: customer.email
    }),
    });
    const { clientSecret } = await res.json();

    const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
      payment_method: { card: cardElement },
    });

    if (error) stripeMessage.textContent = "決済失敗：" + error.message;
    else if (paymentIntent.status === "succeeded") {
      stripeMessage.textContent = "決済成功！ありがとうございます！";
      window.location.href = "/success.html";
    }
  };

    loadProducts();
  </script>

  <footer class="site-footer">
    <p class="site-name">aulibe</p>
    <p class="accepted-text">お支払い方法：</p>
    <p class="payment-text">Visa / Mastercard / JCB / PayPay</p>
    <p class="small-note">※ロゴは商標ガイドラインに基づき省略しています。</p>
    
    <p class="tokusho-link"><a href="tokusho.html" target="_blank">特定商取引法に基づく表記</a></p>
  </footer>
</body>
</html>