<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Mode Apparel</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://js.stripe.com/v3/"></script>
  <div class="cart-link">
  <a href="checkout.html">ã‚«ãƒ¼ãƒˆã‚’è¦‹ã‚‹</a>
</div>
</head>
<body>
  <header class="site-header">
  <div class="title-box">
    <h1 class="site-title">aulibe</h1>
    <p class="tagline">FOR MF</p>
  </div>

  <nav class="sub-nav">
    <ul class="sub-nav-menu">
      <li><a href="tokusho.html" target="_blank">Legal Info</a></li>
      <li><a href="corporate.html" target="_blank">Corporate</a></li>
      <li><a href="access.html" target="_blank">Contact</a></li>
    </ul>
  </nav>

  <div class="cart-link">
    <a href="checkout.html">ğŸ›’ ã‚«ãƒ¼ãƒˆ (<span id="cart-count">0</span>)</a>
  </div>

</header>

  <main>
    <section class="products" id="product-list">
      <!-- å•†å“ã‚«ãƒ¼ãƒ‰ã¯ JS ã§ç”Ÿæˆ -->
    </section>

    <!-- è³¼å…¥è€…æƒ…å ±ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div id="customer-info">
      <h3>ãŠå±Šã‘å…ˆæƒ…å ±</h3>
      <label>åå‰ï¼š
        <input type="text" id="customer-name" required>
      </label><br>
      <label>ä½æ‰€ï¼š
        <input type="text" id="customer-address" required>
      </label><br>
      <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆå¿…é ˆï¼‰ï¼š
        <input type="email" id="customer-email" required>
      </label><br>
      <label>é›»è©±ç•ªå·ï¼š
        <input type="text" id="customer-phone">
      </label><br>
    </div>

    <!-- ç”»åƒæ‹¡å¤§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="img-modal" class="img-modal">
      <span class="img-close">&times;</span>
      <img class="img-modal-content" id="modal-img">
    </div>
  </main>

  <!-- Stripe ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="stripe-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’å…¥åŠ›</h2>
      <div id="card-element"></div>
      <button id="confirm-payment">æ”¯æ‰•ã†</button>
      <p id="stripe-message"></p>
    </div>
  </div>

  <script>
    let selectedProduct = {};

    // é›»è©±ç•ªå·ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆ10æ¡ã¾ãŸã¯11æ¡ã€ãƒã‚¤ãƒ•ãƒ³OKï¼‰
    function validatePhone(phone) {
      const numbers = phone.replace(/-/g, ""); // ãƒã‚¤ãƒ•ãƒ³å‰Šé™¤
      return /^\d+$/.test(numbers) && (numbers.length === 10 || numbers.length === 11);
    }

    // å…¥åŠ›æœªè¨˜å…¥ãƒã‚§ãƒƒã‚¯
    function validateCustomerInfo() {
      const name = document.getElementById("customer-name").value.trim();
      const address = document.getElementById("customer-address").value.trim();
      const phone = document.getElementById("customer-phone").value.trim();
      const email = document.getElementById("customer-email").value.trim();

      if (!name || !address || !phone || !email) {
        alert("åå‰ãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ãƒ»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");
        return false;
      }

      if (!validatePhone(phone)) {
        alert("é›»è©±ç•ªå·ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆ10ã€œ11æ¡ã®æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³å¯ï¼‰");
        return false;
      }
      // email ã®å½¢å¼ãƒã‚§ãƒƒã‚¯
      if (!email.match(/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/)) {
        alert("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒä¸æ­£ã§ã™");
        return false;
      }

      return { name, address, phone, email }; // â† email ã‚’è¿”ã™
    }

    // å•†å“ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    async function loadProducts() {
      const res = await fetch("/products");
      const products = await res.json();

      const list = document.getElementById("product-list");
      list.innerHTML = "";

      products.forEach(p => {
        list.innerHTML += `
          <div class="product-card">
            <img src="img/${p.id}.jpg" class="product-img">
            <h3>${p.name}</h3>
            <p>Â¥${p.price.toLocaleString()}</p>
            <button class="add-cart-btn"
              data-id="${p.id}"
              data-name="${p.name}"
              data-price="${p.price}">
              ã‚«ãƒ¼ãƒˆã«å…¥ã‚Œã‚‹
            </button>
          </div>
        `;
      });

      // âš¡é‡è¦ï¼šå•†å“ãŒæç”»ã•ã‚ŒãŸå¾Œã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®šï¼
      attachBuyEvents();
    }

    // ã‚«ãƒ¼ãƒˆã®å€‹æ•°ã‚’æ›´æ–°
    function loadCartCount() {
          const cart = JSON.parse(localStorage.getItem("cart") || "[]");
          const count = cart.reduce((sum, item) => sum + item.qty, 0);
          const el = document.getElementById("cart-count");
          if (el) el.textContent = count;
        }
    updateCartCount();
    

    // å•†å“ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    function attachBuyEvents() {

    // ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
    document.querySelectorAll(".add-cart-btn").forEach(btn => {
      btn.onclick = () => {
        addToCart({
          id: Number(btn.dataset.id),
          name: btn.dataset.name,
          price: Number(btn.dataset.price)
        });
      };
    });

    // Stripeãƒœã‚¿ãƒ³
    document.querySelectorAll(".stripe-btn").forEach(btn => {
      btn.onclick = () => {
        const customer = validateCustomerInfo();
        if (!customer) return;

        selectedProduct = {
          name: btn.dataset.name,
          price: parseInt(btn.dataset.price),
          customer
        };
        modal.style.display = "block";
      };
    });

    // PayPayãƒœã‚¿ãƒ³
    document.querySelectorAll(".paypay-btn").forEach(btn => {
      btn.onclick = async () => {
        const customer = validateCustomerInfo();
        if (!customer) return;

        const amount = parseInt(btn.dataset.price) * 100;

        const res = await fetch("/paypay-payment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amount: amount,
            description: btn.dataset.name,
            name: customer.name,
            address: customer.address,
            phone: customer.phone,
            email: customer.email
          }),
        });

        const data = await res.json();
        if (data.status === "success") {
          alert(`PayPayæ±ºæ¸ˆå®Œäº†ï¼é‡‘é¡: Â¥${parseInt(btn.dataset.price)}`);
          window.location.href = "/success.html";
        } else {
          alert("PayPayæ±ºæ¸ˆå¤±æ•—ï¼š" + (data.message || ""));
        }
      };
    });

    // ç”»åƒã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§
    document.querySelectorAll(".product-img").forEach(img => {
      img.onclick = () => {
        modalImg.src = img.src;
        imgModal.style.display = "block";
      };
    });
  }


    // ã‚«ãƒ¼ãƒˆæ©Ÿèƒ½
    function addToCart(product) {
      let cart = JSON.parse(localStorage.getItem("cart") || "[]");

      const exist = cart.find(item => item.id === product.id);
      if (exist) {
        exist.qty += 1;
      } else {
        cart.push({ ...product, qty: 1 });
      }

      localStorage.setItem("cart", JSON.stringify(cart));
      updateCartCount(); // â† è¿½åŠ 
      alert("ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸï¼");
    }
    

    // ---------------- Stripeè¨­å®š ----------------
    const stripe = Stripe("pk_test_51SQTLLRytEfLIwOYuSDMMX63MpF0xZYUGwzpFC13lHufZlVubPhhmQr3QbWMVsLoR8iOgn2m0ftK129AYnRP48o200RqBen43R"); // è‡ªåˆ†ã®å…¬é–‹ã‚­ãƒ¼
    const elements = stripe.elements();
    const cardElement = elements.create("card");
    cardElement.mount("#card-element");

    const modal = document.getElementById("stripe-modal");
    const closeModal = document.querySelector(".close");
    const stripeMessage = document.getElementById("stripe-message");
    const imgModal = document.getElementById("img-modal");
    const modalImg = document.getElementById("modal-img");
    const imgClose = document.querySelector(".img-close");

    closeModal.onclick = () => (modal.style.display = "none");
    imgClose.onclick = () => (imgModal.style.display = "none");

    window.onclick = (e) => {
      if (e.target == modal) modal.style.display = "none";
      if (e.target == imgModal) imgModal.style.display = "none";
    };

    document.getElementById("confirm-payment").onclick = async () => {
  const customer = validateCustomerInfo();
  if (!customer) return; // å…¥åŠ›ä¸æ­£ãªã‚‰å‡¦ç†åœæ­¢

  stripeMessage.textContent = "æ±ºæ¸ˆä¸­â€¦";
  const res = await fetch("/create-payment-intent", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      amount: selectedProduct.price * 100,
      description: selectedProduct.name,
      name: customer.name,
      address: customer.address,
      phone: customer.phone,
      email: customer.email
    }),
    });
    const { clientSecret } = await res.json();

    const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
      payment_method: { card: cardElement },
    });

    if (error) stripeMessage.textContent = "æ±ºæ¸ˆå¤±æ•—ï¼š" + error.message;
    else if (paymentIntent.status === "succeeded") {
      stripeMessage.textContent = "æ±ºæ¸ˆæˆåŠŸï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼";
      window.location.href = "/success.html";
    }
  };

    loadProducts();
  </script>

  <footer class="site-footer">
    <p class="site-name">aulibe</p>
    <p class="accepted-text">ãŠæ”¯æ‰•ã„æ–¹æ³•ï¼š</p>
    <p class="payment-text">Visa / Mastercard / JCB / PayPay</p>
    <p class="small-note">â€»ãƒ­ã‚´ã¯å•†æ¨™ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«åŸºã¥ãçœç•¥ã—ã¦ã„ã¾ã™ã€‚</p>
    
    <p class="tokusho-link"><a href="tokusho.html" target="_blank">ç‰¹å®šå•†å–å¼•æ³•ã«åŸºã¥ãè¡¨è¨˜</a></p>
  </footer>
</body>
</html>